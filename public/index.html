<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1" />
		<title>Catan Deck</title>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
		<link
			rel="stylesheet"
			href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css"
		/>
		<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"></script>

		<!-- update the version number as needed -->
		<script defer src="/__/firebase/7.13.2/firebase-app.js"></script>
		<!-- include only the Firebase features as you need -->
		<script defer src="/__/firebase/7.13.2/firebase-auth.js"></script>
		<script defer src="/__/firebase/7.13.2/firebase-database.js"></script>
		<script defer src="/__/firebase/7.13.2/firebase-messaging.js"></script>
		<script defer src="/__/firebase/7.13.2/firebase-storage.js"></script>
		<!-- initialize the SDK after all desired features are loaded -->
		<script defer src="/__/firebase/init.js"></script>
		<script src="https://www.gstatic.com/firebasejs/6.0.4/firebase-app.js"></script>
		<script src="https://www.gstatic.com/firebasejs/6.0.4/firebase-database.js"></script>
	</head>
	<body>
		<h2>Cards Used: <span id="card-count"></span></h2>

		<button onclick="pickCard()">Pick Card</button>
		<button onclick="resetDeck()">Reset Deck</button>

		<div id="hand"></div>
		<br /><br />

		<button onclick="useKnight()">Knight</button>

		<div id="used"></div>

		<button id="dice" onclick="rollDice()">Roll</button>

		<script>
			const config = {
				apiKey: "AIzaSyCHxywW-RjXx3LqlX38eEVCcdjMoo9IbqM",
				authDomain: "catan-addcc.firebaseapp.com",
				databaseURL: "https://catan-addcc.firebaseio.com",
				projectId: "catan-addcc",
				storageBucket: "catan-addcc.appspot.com",
			};
			firebase.initializeApp(config);

			const database = firebase.database();
			const connectionsRef = database.ref("/connections");
			const connectedRef = database.ref(".info/connected");
			let currentDeck = [];
			let a = JSON.parse(readCookie("myHand"));
			b = readCookie("knightCount");
			let myHand = a ? a : [];
			let knightCount = b ? b : 0;

			const resetDeck = () => {
				if (confirm("are you sure?")) {
					database.ref().set({ deck: JSON.stringify(createDeck()) });
				}
			};
			const pickCard = () => {
				const n = Math.floor(Math.random() * currentDeck.length);
				myHand.push(currentDeck[n]);

				currentDeck.splice(n, 1);
				showHand();
				database.ref().update({ deck: JSON.stringify(currentDeck) });
			};
			const showHand = () => {
				document.cookie = "myHand=" + JSON.stringify(myHand);
				//localStorage.setItem("myHand", [...myHand]);
				$("#hand").empty();
				myHand.forEach((e) => {
					let card = $("<h4>").text(e);
					$("#hand").append(card);
				});
				$("#used").text("Knights Used: " + knightCount);
			};
			const useKnight = () => {
				const i = myHand.indexOf("Knight");
				if (i > -1) {
					if (confirm("Use Knight?")) {
						knightCount++;
						document.cookie = "knightCount=" + knightCount;
						//	localStorage.setItem("knightCount", knightCount);
						myHand.splice(i, 1);
						showHand();
					}
				}
			};
			window.onload = () => {
				database.ref().on("value", (snap) => {
					$("#dice").text(snap.val().roll);
					currentDeck = JSON.parse(snap.val().deck);
					$("#card-count").text(34 - currentDeck.length);

					if (currentDeck.length === 34) {
						myHand = [];
						knightCount = 0;
						document.cookie = "myHand=" + JSON.stringify(myHand);
						document.cookie = "knightCount=" + knightCount;

						//	localStorage.setItem("myHand", [...myHand]);
						//	localStorage.setItem("knightCount", knightCount);
						showHand();
					}
				});
				// connectedRef.on("value", (snap) => {
				// 	console.log("snap val", snap.val());
				// 	if (snap.val()) {
				// 		let con = connectionsRef.push(true);

				// 		con.onDisconnect().remove();
				// 	}
				// });
				showHand();
			};
			let createDeck = () => {
				let cards = [];
				for (let i = 0; i < 20; i++) {
					cards.push("Knight");
				}
				for (let i = 0; i < 3; i++) {
					cards.push("Road Building");
				}
				for (let i = 0; i < 3; i++) {
					cards.push("Year of Plenty");
				}
				for (let i = 0; i < 3; i++) {
					cards.push("Monopoly");
				}
				for (let i = 0; i < 5; i++) {
					cards.push("Victory Point");
				}
				return cards;
			};
			function readCookie(name) {
				var nameEQ = name + "=";
				var ca = document.cookie.split(";");
				for (var i = 0; i < ca.length; i++) {
					var c = ca[i];
					while (c.charAt(0) === " ") c = c.substring(1, c.length);
					if (c.indexOf(nameEQ) === 0) {
						return c.substring(nameEQ.length, c.length);
					}
				}
				return null;
			}
			rollDice = () => {
				let a = Math.ceil(Math.random() * 6) + Math.ceil(Math.random() * 6);
				database.ref().update({ roll: a });
			};
		</script>
		<style>
			button {
				width: 45%;
				line-height: 2;
			}
			#dice {
				font-size: 50px;
				color: red;
				position: fixed;
				right: 0;
				bottom: 0;
				text-align: center;
				float: right;
			}
		</style>
	</body>
</html>
